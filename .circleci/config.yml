version: 2
jobs:
  build:
    docker:
      - image: circleci/ruby:2.4.2-jessie-node
    steps:
      - checkout
      - run:
           name: build
           command: gem build fdk.gemspec
      - run:
           name: build
           command: gem install --development *.gem
      - run:
          name: Run tests
          command: |
            rake test
      - run:
           name: Release if master
           command: |
             if [[ "${CIRCLE_BRANCH}" == "master" && -z "${CIRCLE_PR_REPONAME}" ]]; then
                git config --global user.email "ci@fnproject.com"
                git config --global user.name "CI"
                git branch --set-upstream-to=origin/${CIRCLE_BRANCH} ${CIRCLE_BRANCH}
                mkdir -p ~/.gem
                echo "---\n:rubygems_api_key:${GEM_API_KEY}" >> ~/.gem/credentials
                chmod 600 ~/.gem/credentials
                ./release.sh
              fi

